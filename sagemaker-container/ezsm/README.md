# Deployment to GPU endpoints with ezsmdeploy

NOTE: ezsmdeploy is not ready for production:

- 1.0.8 is broken: I've reported <https://github.com/aws-samples/easy-amazon-sagemaker-deployments/issues/7>. After fixing the issue myself the deploymetn starts working, but it doesn't reach `In Service` state.

- The `Dockerfile` generated by `ezsmdeploy` doesn't seem to use the base image I specify.

## Local test

```bash
docker build -f Dockerfile.test -t test-difflearning .
docker run -it --rm test-difflearning
```

In the container:

```bash
python test.py
```

## Publish base image in ECR for ezsmdeploy

Push `tensorflow/tensorflow:latest-gpu` into ECR, otherwise ezsmdeploy won't be able to use it.

```bash
docker pull tensorflow/tensorflow:latest-gpu
IMAGE_ID=$(docker images tensorflow/tensorflow:latest-gpu -q)

docker tag $IMAGE_ID $ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/tensorflow/tensorflow:latest-gpu
$(aws ecr get-login --no-include-email --registry-ids $ACCOUNT_ID)
aws ecr describe-repositories --repository-names tensorflow/tensorflow || aws ecr create-repository --repository-name  tensorflow/tensorflow 
docker push $ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/tensorflow/tensorflow:latest-gpu
```

## References

- <https://github.com/bobbruno/MUSE-sagemaker-demo/blob/ca6823bd31ffa7a0f62a2af5fb97869b78e9e5b1/notebooks/3-sm-job/byoc/byoc_tf_2.ipynb>

- <https://github.com/aws-samples/amazon-sagemaker-immersion-day/blob/master/bring-custom-container.ipynb>